# syntax = docker/dockerfile:experimental

ARG VERSION=master
FROM localhost:5000/src:${VERSION} as src

FROM golang:1.15 as builder

COPY --from=src /go/src /go/src

WORKDIR /go/src/

RUN --mount=type=cache,id=gomod,target=/go/pkg/mod \
    CGO_ENABLED=0 go build -o /go/bin/docker-buildx ./cmd/buildx

FROM docker
RUN apk add --no-cache make
COPY --from=builder /go/bin/docker-buildx /root/.docker/cli-plugins/docker-buildx
ENV DOCKER_CLI_EXPERIMENTAL=enabled
